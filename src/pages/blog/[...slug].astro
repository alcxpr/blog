---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import TagList from "../../components/TagList.astro";
import HomeIcon from "../../components/HomeIcon.astro";
import CodeCopyButton from "../../components/CodeCopyButton.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { getPublishedPosts, calculateReadingTime } from "../../utils/posts";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const posts = getPublishedPosts(allPosts);

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await post.render();

function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

const readingTime = calculateReadingTime(post.body);

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: post.data.title },
];
---

<BaseLayout title={`${post.data.title} - Compiler Log`} description={post.data.description}>
  <article>
    <Breadcrumb items={breadcrumbItems} />
    <h1>{post.data.title}</h1>
    <div class="post-meta">
      <div class="post-info">
        <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
        <span class="separator">â€¢</span>
        <span class="reading-time">{readingTime} min read</span>
      </div>
      {
        post.data.tags.length > 0 && (
          <div class="post-tags">
            <TagList tags={post.data.tags} />
          </div>
        )
      }
    </div>
    <Content />
  </article>
  <CodeCopyButton />
</BaseLayout>

<style>
  .post-meta {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .post-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--muted-color, #9ca3af);
    font-size: 0.95rem;
  }

  .separator {
    color: var(--muted-color, #9ca3af);
  }

  .reading-time {
    color: var(--muted-color, #9ca3af);
  }

  .post-tags {
    margin-top: 0.5rem;
  }

  time {
    color: var(--muted-color, #9ca3af);
  }

  [data-theme="light"] .post-info,
  [data-theme="light"] time,
  [data-theme="light"] .separator,
  [data-theme="light"] .reading-time {
    color: #6b7280;
  }
</style>
